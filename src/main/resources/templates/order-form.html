<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Create Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stock-warning { color: red; font-size: 0.875em; }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <h2 class="mb-4">Create New Order</h2>

    <form id="orderForm" th:action="@{/orders/save}" th:object="${order}" method="post">

        <!-- Messages -->
        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">Please correct the errors below.</div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <!-- Client Name -->
        <div class="mb-3">
            <label class="form-label">Client Name</label>
            <input type="text" class="form-control" th:field="*{clientName}" id="clientName" required />
            <div class="invalid-feedback d-block" th:errors="*{clientName}"></div>
        </div>

        <h5 class="mb-3">Order Items</h5>
        <div class="alert alert-warning py-2 px-3" id="emptyWarning" style="display: none;">
            You must add at least one product to the order.
        </div>

        <table class="table table-bordered align-middle" id="orderTable">
            <thead class="table-light">
            <tr>
                <th>Product</th>
                <th>Stock</th>
                <th>Unit Price</th>
                <th>Quantity</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="orderBody"></tbody>
        </table>

        <div class="mb-3">
            <button type="button" class="btn btn-outline-primary" onclick="addRow()">
                <i class="bi bi-plus-circle"></i> Add Item
            </button>
        </div>

        <div class="d-flex justify-content-end mt-4">
            <a href="/orders" class="btn btn-secondary me-2">Cancel</a>
            <button type="button" class="btn btn-success" onclick="confirmOrder()">
                <i class="bi bi-cart-check"></i> Submit Order
            </button>
        </div>
    </form>
</div>

<!-- Modal confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Client:</strong> <span id="modalClient"></span></p>
                <p><strong>Items:</strong> <span id="modalLines"></span></p>
                <p><strong>Estimated Total:</strong> <span id="modalTotal"></span> FCFA</p>
                <p class="text-muted small">Are you sure you want to submit this order?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitConfirmedOrder()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script th:inline="javascript">
    const products = /*[[${products}]]*/ [];
</script>

<script>
    let rowCount = 0;

    function addRow() {
      const tbody = document.getElementById("orderBody");
      const row = document.createElement("tr");

      const options = products.map(p => `
        <option value="${p.id}" data-stock="${p.stockQuantity}" data-price="${p.unitPrice}">
          ${p.name}
        </option>`).join("");

      row.innerHTML = `
        <td>
          <select name="items[${rowCount}].product.id" class="form-select" onchange="updateRow(this)" required>
            <option value="">-- Select --</option>
            ${options}
          </select>
        </td>
        <td class="stock-cell text-center">-</td>
        <td class="price-cell text-center">-</td>
        <td>
          <input type="number" name="items[${rowCount}].quantite" class="form-control qty-field" min="0" value="0" oninput="checkStock(this)" required />
          <div class="stock-warning" style="display: none;">Insufficient stock!</div>
        </td>
        <td class="text-center">
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">
            &times;
          </button>
        </td>
      `;
      tbody.appendChild(row);
      rowCount++;
    }

    function updateRow(select) {
      const stock = select.options[select.selectedIndex].dataset.stock;
      const price = select.options[select.selectedIndex].dataset.price;

      const row = select.closest("tr");
      row.querySelector(".stock-cell").textContent = stock || "-";
      row.querySelector(".price-cell").textContent = price || "-";
      row.querySelector(".qty-field").setAttribute("max", stock);
    }

    function checkStock(input) {
      const row = input.closest("tr");
      const stock = parseInt(row.querySelector("select").selectedOptions[0].dataset.stock || "0");
      const qty = parseInt(input.value || "0");
      const warning = row.querySelector(".stock-warning");

      warning.style.display = qty > stock ? "block" : "none";
    }

    function confirmOrder() {
      const rows = document.querySelectorAll("#orderBody tr");
      const clientName = document.getElementById("clientName").value.trim();
      const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
      const warning = document.getElementById("emptyWarning");

      let total = 0;
      let count = 0;

      rows.forEach(row => {
        const select = row.querySelector("select");
        const qty = parseInt(row.querySelector("input").value || "0");
        const price = parseFloat(select.selectedOptions[0]?.dataset.price || "0");

        if (select.value && qty > 0) {
          count++;
          total += price * qty;
        }
      });

      if (count === 0) {
        warning.style.display = "block";
        return;
      }

      warning.style.display = "none";
      document.getElementById("modalClient").textContent = clientName || "N/A";
      document.getElementById("modalLines").textContent = count;
      document.getElementById("modalTotal").textContent = total.toFixed(2);
      modal.show();
    }

    function submitConfirmedOrder() {
      document.getElementById("orderForm").submit();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
